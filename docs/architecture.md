# Архитектура системы BookPilot

## Общая архитектура

BookPilot представляет собой полноценное веб-приложение, состоящее из следующих основных компонентов:

1. **Фронтенд (Next.js + Tailwind CSS)**
   - Клиентская часть приложения
   - Отвечает за пользовательский интерфейс и взаимодействие с пользователем
   - Развертывается на Vercel

2. **Бэкенд (FastAPI)**
   - Серверная часть приложения
   - Обрабатывает запросы от фронтенда
   - Взаимодействует с базой данных и внешними API
   - Развертывается на Railway

3. **База данных (PostgreSQL)**
   - Хранит данные пользователей, книг и учебных руководств
   - Может быть развернута через Supabase или напрямую

4. **Хранилище файлов (Supabase Storage или AWS S3)**
   - Хранит загруженные пользователями книги
   - Обеспечивает доступ к файлам через API

5. **Сервис LLM (OpenAI GPT-4)**
   - Обрабатывает текст книг
   - Генерирует учебные руководства
   - Обеспечивает функциональность чата

## Схема базы данных

### Таблица `users`
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) NOT NULL UNIQUE,
    provider VARCHAR(50) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP WITH TIME ZONE
);
```

### Таблица `books`
```sql
CREATE TABLE books (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    title VARCHAR(255) NOT NULL,
    author VARCHAR(255),
    file_url VARCHAR(512) NOT NULL,
    file_type VARCHAR(10) NOT NULL,
    file_size INTEGER NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'processing',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Таблица `guides`
```sql
CREATE TABLE guides (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    book_id UUID NOT NULL REFERENCES books(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    json_content JSONB NOT NULL,
    progress JSONB DEFAULT '{"completed_chapters": [], "completed_tasks": [], "quiz_results": null}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Таблица `highlights` (опционально)
```sql
CREATE TABLE highlights (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    content TEXT NOT NULL,
    book_id UUID NOT NULL REFERENCES books(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    source VARCHAR(50) DEFAULT 'manual',
    page_number INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Таблица `chats` (опционально)
```sql
CREATE TABLE chats (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    book_id UUID NOT NULL REFERENCES books(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    messages JSONB NOT NULL DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

### Таблица `exports` (новая функциональность)
```sql
CREATE TABLE exports (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    guide_id UUID NOT NULL REFERENCES guides(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    format VARCHAR(10) NOT NULL,
    file_url VARCHAR(512) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

## API эндпоинты

### Аутентификация
- `POST /api/auth/register` - Регистрация нового пользователя
- `POST /api/auth/login` - Вход в систему
- `POST /api/auth/logout` - Выход из системы
- `GET /api/auth/me` - Получение информации о текущем пользователе

### Книги
- `POST /api/books` - Загрузка новой книги
- `GET /api/books` - Получение списка книг пользователя
- `GET /api/books/{book_id}` - Получение информации о конкретной книге
- `DELETE /api/books/{book_id}` - Удаление книги
- `POST /api/books/{book_id}/process` - Запуск обработки книги

### Учебные руководства
- `GET /api/guides/{book_id}` - Получение учебного руководства для книги
- `PATCH /api/guides/{book_id}/progress` - Обновление прогресса по руководству
- `GET /api/guides/{book_id}/quiz` - Получение викторины для книги
- `POST /api/guides/{book_id}/quiz/results` - Сохранение результатов викторины
- `POST /api/guides/{book_id}/export` - Экспорт руководства в PDF (новая функциональность)

### Выделения (опционально)
- `POST /api/highlights` - Создание нового выделения
- `GET /api/highlights/{book_id}` - Получение выделений для книги
- `DELETE /api/highlights/{highlight_id}` - Удаление выделения

### Чат (опционально)
- `POST /api/chat/{book_id}/messages` - Отправка сообщения в чат
- `GET /api/chat/{book_id}/messages` - Получение истории сообщений чата

### Readwise (опционально)
- `POST /api/integrations/readwise/connect` - Подключение к Readwise
- `GET /api/integrations/readwise/books` - Получение книг из Readwise
- `POST /api/integrations/readwise/import/{book_id}` - Импорт выделений из Readwise

## Структура фронтенда

### Страницы
- `/` - Главная страница (лендинг)
- `/auth/login` - Страница входа
- `/auth/register` - Страница регистрации
- `/dashboard` - Личный кабинет пользователя
- `/books` - Список книг пользователя
- `/books/upload` - Страница загрузки книги
- `/books/{book_id}` - Страница с информацией о книге
- `/guides/{book_id}` - Страница с учебным руководством
- `/guides/{book_id}/quiz` - Страница с викториной
- `/chat/{book_id}` - Страница чата с ИИ о книге
- `/profile` - Профиль пользователя

### Компоненты
- `Layout` - Общий макет приложения
- `Navbar` - Навигационная панель
- `Footer` - Подвал сайта
- `BookCard` - Карточка книги
- `GuideSection` - Раздел учебного руководства
- `ChapterSummary` - Резюме главы
- `ReflectiveQuestion` - Рефлексивный вопрос
- `ActionableTask` - Практическое задание
- `ProgressTracker` - Отслеживание прогресса
- `Quiz` - Компонент викторины
- `ChatInterface` - Интерфейс чата
- `FileUploader` - Компонент загрузки файлов
- `PDFExporter` - Компонент экспорта в PDF (новая функциональность)
- `MobileNavigation` - Навигация для мобильных устройств (новая функциональность)

## Взаимодействие компонентов

1. **Загрузка книги**
   - Пользователь загружает книгу через фронтенд
   - Фронтенд отправляет файл на бэкенд
   - Бэкенд сохраняет файл в хранилище
   - Бэкенд создает запись в базе данных
   - Бэкенд запускает процесс обработки книги

2. **Обработка книги**
   - Бэкенд извлекает текст из файла книги
   - Бэкенд разбивает текст на части (чанки)
   - Бэкенд отправляет чанки в LLM API
   - LLM генерирует учебное руководство
   - Бэкенд сохраняет руководство в базе данных

3. **Отображение руководства**
   - Пользователь запрашивает руководство через фронтенд
   - Фронтенд отправляет запрос на бэкенд
   - Бэкенд получает руководство из базы данных
   - Бэкенд отправляет руководство на фронтенд
   - Фронтенд отображает руководство пользователю

4. **Отслеживание прогресса**
   - Пользователь отмечает выполненные задания
   - Фронтенд отправляет обновления на бэкенд
   - Бэкенд обновляет прогресс в базе данных
   - Бэкенд отправляет обновленный прогресс на фронтенд
   - Фронтенд отображает обновленный прогресс

5. **Чат с ИИ**
   - Пользователь отправляет сообщение через фронтенд
   - Фронтенд отправляет сообщение на бэкенд
   - Бэкенд отправляет сообщение и контекст книги в LLM API
   - LLM генерирует ответ
   - Бэкенд сохраняет сообщение и ответ в базе данных
   - Бэкенд отправляет ответ на фронтенд
   - Фронтенд отображает ответ пользователю

6. **Экспорт руководства в PDF** (новая функциональность)
   - Пользователь запрашивает экспорт руководства
   - Фронтенд отправляет запрос на бэкенд
   - Бэкенд генерирует PDF-файл на основе руководства
   - Бэкенд сохраняет файл в хранилище
   - Бэкенд создает запись в таблице exports
   - Бэкенд отправляет URL файла на фронтенд
   - Фронтенд предлагает пользователю скачать файл

## Обработка книг и взаимодействие с LLM

1. **Извлечение текста**
   - Для PDF: использование библиотеки PyPDF2 или pdfplumber
   - Для ePub: использование библиотеки ebooklib
   - Для TXT: прямое чтение файла

2. **Разбиение текста**
   - Разделение текста на главы (если возможно)
   - Разбиение больших глав на части по ~2000 токенов
   - Сохранение структуры и последовательности

3. **Оптимизация для больших книг** (улучшение)
   - Параллельная обработка частей книги
   - Кэширование промежуточных результатов
   - Приоритизация обработки начала книги для быстрого отображения первых глав

4. **Генерация руководства**
   - Отправка текста в LLM API с соответствующим промптом
   - Обработка ответа LLM
   - Структурирование руководства в JSON формат

5. **Формат JSON для руководства**
```json
{
  "title": "Название книги",
  "author": "Автор книги (если доступно)",
  "toc": ["Глава 1", "Глава 2", ...],
  "chapters": [
    {
      "title": "Глава 1",
      "summary": "Резюме главы...",
      "questions": ["Вопрос 1?", "Вопрос 2?"],
      "task": "Практическое задание..."
    },
    ...
  ],
  "synthesis": {
    "key_takeaways": ["Вывод 1", "Вывод 2", ...],
    "action_plan": "План действий..."
  },
  "quiz": [
    {
      "question": "Вопрос викторины?",
      "options": ["Вариант A", "Вариант B", "Вариант C", "Вариант D"],
      "correct_answer": 0
    },
    ...
  ]
}
```

## Улучшения архитектуры

1. **Адаптивный дизайн**
   - Использование медиа-запросов для адаптации интерфейса под разные устройства
   - Специальная навигация для мобильных устройств
   - Оптимизация изображений и контента для мобильных устройств

2. **Оптимизация производительности**
   - Использование серверных компонентов Next.js для улучшения производительности
   - Ленивая загрузка компонентов и изображений
   - Кэширование данных на стороне клиента

3. **Улучшенный чат с ИИ**
   - Сохранение контекста беседы для более релевантных ответов
   - Возможность цитирования конкретных частей книги
   - Интеграция с учебным руководством для контекстных вопросов

4. **Экспорт в PDF**
   - Генерация стилизованных PDF-файлов с учебным руководством
   - Возможность выбора разделов для экспорта
   - Добавление персонализированных заметок в экспортируемый файл

5. **SEO и доступность**
   - Метаданные для поисковых систем
   - Семантическая разметка HTML
   - Поддержка скринридеров и клавиатурной навигации
   - Соответствие стандартам WCAG 2.1

## Безопасность

1. **Аутентификация**
   - Использование JWT токенов для аутентификации
   - Хранение токенов в HttpOnly cookies
   - Использование HTTPS для всех запросов

2. **Авторизация**
   - Проверка прав доступа для всех запросов
   - Доступ к ресурсам только для их владельцев

3. **Защита данных**
   - Валидация всех входных данных
   - Защита от SQL-инъекций через ORM
   - Защита от XSS-атак

4. **API ключи**
   - Безопасное хранение API ключей (OpenAI, Readwise)
   - Использование переменных окружения

## Масштабируемость

1. **Обработка книг**
   - Асинхронная обработка книг через очередь задач
   - Возможность горизонтального масштабирования обработчиков

2. **Кэширование**
   - Кэширование часто запрашиваемых данных
   - Использование Redis для кэширования (опционально)

3. **База данных**
   - Индексирование часто запрашиваемых полей
   - Оптимизация запросов

## Мониторинг и логирование

1. **Логирование**
   - Логирование всех API запросов
   - Логирование ошибок и исключений

2. **Мониторинг**
   - Мониторинг производительности API
   - Мониторинг использования ресурсов

## Развертывание

1. **Фронтенд (Vercel)**
   - Автоматическое развертывание из репозитория
   - Настройка переменных окружения

2. **Бэкенд (Railway)**
   - Автоматическое развертывание из репозитория
   - Настройка переменных окружения
   - Подключение к базе данных

3. **База данных**
   - Развертывание PostgreSQL через Railway или Supabase
   - Настройка резервного копирования

4. **CI/CD**
   - Настройка GitHub Actions для автоматического тестирования
   - Автоматическое развертывание при успешном прохождении тестов
